~/workspace$ npm run test:agents -- --run --reporter=verbose src/agents/__tests__/integration.test.ts

> envelope-app-backend@1.0.0 test:agents
> vitest run --config vitest.config.agents.ts --run --reporter=verbose src/agents/__tests__/integration.test.ts


 RUN  v1.6.1 /home/runner/workspace

 ❯ |agents| src/agents/__tests__/integration.test.ts (16)
   ❯ Agent API Integration Tests (16)
     ❯ POST /api/ai/chat (5)
       ✓ should handle basic chat request successfully
       ✓ should route to appropriate agent based on message
       × should include conversation history when requested
       ✓ should handle validation errors
       ✓ should require authentication
     ✓ POST /api/ai/tools/execute (2)
       ✓ should execute tool directly
       ✓ should handle tool execution errors
     ✓ POST /api/ai/handoff (2)
       ✓ should handle agent handoff successfully
       ✓ should validate agent names in handoff
     ✓ GET /api/ai/agents (1)
       ✓ should return list of available agents
     ✓ GET /api/ai/tools (2)
       ✓ should return list of available tools
       ✓ should filter tools by category
     ✓ GET /api/ai/sessions/:sessionId/history (1)
       ✓ should return conversation history
     ✓ GET /api/ai/status (1)
       ✓ should return system status
     ✓ Error Handling (2)
       ✓ should handle database connection errors gracefully
       ✓ should handle agent unavailability

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ Failed Tests 1 ⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯

 FAIL  |agents| src/agents/__tests__/integration.test.ts > Agent API Integration Tests > POST /api/ai/chat > should include conversation history when requested
AssertionError: expected "spy" to be called at least once
 ❯ src/agents/__tests__/integration.test.ts:209:58
    207| 
    208|       expect(mockResponse.status).toBe(200…
    209|       expect(vi.mocked(mockDb.db.conversat…
       |                                                          ^
    210|     });
    211| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯

 Test Files  1 failed (1)
      Tests  1 failed | 15 passed (16)
   Start at  00:18:18
   Duration  580ms (transform 147ms, setup 107ms, collect 78ms, tests 42ms, environment 0ms, prepare 109ms)